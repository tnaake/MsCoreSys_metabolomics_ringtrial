---
title: "03_similarity"
author:
    - Thomas Naake^[Physikalisch-Technische Bundesanstalt, Bundesallee 100, 38116 Braunschweig, Germany]
fig_width: 15
fig_height: 10
fontsize: 12pt
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: TRUE
    theme: united
    number_sections: true
    highlight: tango
---

```{r env, include=FALSE, echo=FALSE, cache=FALSE}
suppressPackageStartupMessages(library("MsQuality"))
suppressPackageStartupMessages(library("Spectra"))
knitr::opts_knit$set(root.dir = "~/Documents/GitHub/MsCoreSys_metabolomics_ringtrial")
```

Run the script `03_distance_from_spectra.py`. 

Load the result into `R`.

Distance matrix `D` containing Wasserstein distances between files. 

```{r}
wasserstein <- read.csv("data/ms2deepscore_wasserstein_distance_matrix.csv", 
    header = TRUE, row.names = 1)
```

Create heatmap.

```{r}
wasserstein <- as.matrix(wasserstein)
sum_nas_rows <- apply(wasserstein, 1, function(rows_i) sum(is.na(rows_i)))
sum_nas_cols <- apply(wasserstein, 2, function(cols_i) sum(is.na(cols_i)))
wasserstein <- wasserstein[sum_nas_rows != 577, sum_nas_cols != 577]

hm <- heatmap(wasserstein)
rownames(wasserstein)[hm$rowInd]

d <- stats::cmdscale(wasserstein, k = ncol(wasserstein) - 1, eig = TRUE)
tbl <- tibble::as_tibble(d$points)
colnames(tbl) <- paste("Axis.", seq_len(ncol(tbl)), sep = "")
tbl <- tbl |>
    mutate(sample = rownames(wasserstein))
tbl$sample <- stringr::str_remove(tbl$sample, pattern = "data/lab_") |>
    stringr::str_remove(pattern = "AG_Bindila_MSCoreSys_ringtrial_") |>
    stringr::str_remove(pattern = "_QC_Raw_file") |>
    stringr::str_remove(pattern = "/final/Ring_trial_") |>
    stringr::str_remove(pattern = "_pos_neg/") |>
    stringr::str_remove(pattern = "Ring_trial_") |>
    stringr::str_remove(pattern = "mzML/") |>
    stringr::str_remove(pattern = "_from_wiff/20250110_Metabolomics_Liver_Ringtrial_") |>
    stringr::str_remove(pattern = "_from_wiff2/20250110_Metabolomics_Liver_Ringtrial_") |>
    stringr::str_remove(pattern = "[.]mzML")

## plotting
g <- ggplot2::ggplot(tbl, mapping = aes(x = Axis.1, y = Axis.2, text = sample)) +
    ggplot2::geom_point()
ggplotly(g)
```

Multi-dimensional scaling.
```{r}
wasserstein[10,28] <- wasserstein[10,28] + 1e-10
wasserstein[33,34] <- wasserstein[33,34] + 1e-10
mds <- MASS::isoMDS(wasserstein)
```

